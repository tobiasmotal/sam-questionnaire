<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SAM Questionnaire</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background-color: darkkhaki;
    }
    .hidden {
      display: none;
    }
    .scale-box {
      border: 2px solid #444;   /* dark border */
      border-radius: 12px;      /* rounded corners */
      padding: 15px;            /* spacing inside the box */
      margin: 20px 0;           /* spacing between boxes */
      text-align: center;       /* center images */
      background-color: #fafafa; /* light background */
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* subtle shadow */
    }

    .scale-box img {
      width: 80px;
      border: 3px solid transparent;
      cursor: pointer;
      border-radius: 10px;
    }
    .scale-box img.selected {
      border-color: blue;
    }
    button {
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <!-- Launch Screen -->
  <div id="launch-screen" class="screen">
    <h1>Bus Emulator HMI</h1>
    <p>Bitte drücken Sie "Start" am Anfang der Fahrt.</p>
    <p>Please press the button "Start" at the beginning of the Ride.</p>
    <button onclick="startScenario()">Start</button>
  </div>

  <div id="idle-screen" class="screen hidden">
    <h1>Vielen Dank! Bitte achten Sie wieder auf die Fahrt.</h1>
    <h2>Thank you! Please shift your attention back to the ride.</h2>
  </div>

  <!-- SAM Screen -->
  <div id="sam-screen1" class="screen hidden">
    <h1>Bitte bewerten Sie Ihre Erfahrung. Wählen Sie dafür ein Bild pro Reihe.</h1>
    <h2>Please rate your experience. For that, choose one picture per line.</h2>
    <div class="scale-box" id="valence1"></div>
    <div class="scale-box" id="arousal1"></div>
    <div class="scale-box" id="dominance1"></div>
  </div>

  <div id="sam-screen2" class="screen hidden">
    <h1>Bitte bewerten Sie Ihre Erfahrung. Wählen Sie dafür ein Bild pro Reihe.</h1>
    <h2>Please rate your experience. For that, choose one picture per line.</h2>
    <div id="valence2" class="scale-box"></div>
    <div id="arousal2" class="scale-box"></div>
    <div id="dominance2" class="scale-box"></div>
  </div>
  
  <div id="waiting-screen" class="screen hidden">
    <h1>Die Fahrt läuft. Bitte warten Sie...</h1>
    <h2>Ride started. Please wait...</h2>
  </div>

  <!-- End Screen -->
  <div id="end_screen" class="screen hidden">
    <h1>Vielen Dank für Ihre Teilnahme!</h1>
    <h2>Thank you for your participation!</h2>
    <button onclick="saveCSV()">Download Results</button>
    <button onclick="restartScenario()">Restart</button>
  </div>
  <!-- notification sound -->
  <audio id="notifySound" src="sounds/buzzer.wav" preload="auto"></audio>

  <!-- JavaScript to handle logic -->
  <script>
    const SAM_OPTIONS = 5;
    let responses = { scale1: {}, scale2: {} };
    let secondScaleReady = false;
    let firstScaleAnswered = false;
    let downloadResults = false;

    // function to restore UI state from localStorage    
    function restoreUI() {
      ["scale1","scale2"].forEach((scale, i) => {
        for (let dim in responses[scale]) {
          if (dim === "completedAt") continue;
          let value = responses[scale][dim];
          let img = document.querySelector(
            `#sam-screen${i+1} img[data-scale="${dim}"][data-value="${value}"]`
          );
          if (img) img.classList.add("selected");
        }
      });
    }

    // function to show a specific screen and hide others
    function showScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
      localStorage.setItem("currentScreen", id);
    }

    function scheduleEvents(startTime) {
      const now = Date.now();
      const elapsed = (now - startTime) / 1000;

      const t1 = 285; // time for first scale
      const t2 = 360; // time for second scale

      if (elapsed >= t2) {
        secondScaleReady = true;
        if (firstScaleAnswered) {
          showScreen("sam-screen2");
        } else {
          showScreen("sam-screen1");
        }
      } else if (elapsed >= t1) {
        showScreen("sam-screen1");
        setTimeout(() => {
          secondScaleReady = true;
          if (firstScaleAnswered) {
            showScreen("sam-screen2");
            playNotify();
          }
        }, (t2 - elapsed) * 1000);
      } else {
        showScreen("waiting-screen");
        setTimeout(() => {
          showScreen("sam-screen1");
          playNotify();
        }, (t1 - elapsed) * 1000);

        setTimeout(() => {
          secondScaleReady = true;
          if (firstScaleAnswered) {
            showScreen("sam-screen2");
            playNotify();
          }
        }, (t2 - elapsed) * 1000);
      }
    } // scheduleEvents
    window.addEventListener("DOMContentLoaded", () => {
       // restore responses if present
      const savedResponses = localStorage.getItem("responses");
      if (savedResponses) {
        responses = JSON.parse(savedResponses);
      }

      // restore scale completion flags
      firstScaleAnswered = Boolean(responses.scale1.valence && responses.scale1.arousal && responses.scale1.dominance);

      // rebuild scales always, but clear first to avoid duplicates
      renderScales("sam-screen1","1");
      renderScales("sam-screen2","2");

      // restore selected images
      restoreUI();

      const startTime = localStorage.getItem("scenarioStart");
      //const lastScreen = localStorage.getItem("currentScreen");

      if (startTime) {
        // Always call scheduleEvents to re-establish timeouts
        scheduleEvents(parseInt(startTime));
      } else {
        showScreen("launch-screen");
      }
    });

    function startScenario() {
      const audio = document.getElementById("notifySound");
        audio.play().then(() => {
        audio.pause();
        audio.currentTime = 0;
       }).catch(err => {
        console.log("Safari autoplay lock, but audio unlocked:", err);
      });
      const startTime = Date.now();
      localStorage.setItem("scenarioStart", startTime);
      showScreen("waiting-screen");
      renderScales("sam-screen1","1");
      renderScales("sam-screen2","2");
      scheduleEvents(startTime);
    }

    function playNotify() {
      const audio = document.getElementById("notifySound");
      audio.currentTime = 0;
      audio.play();
    }

    // function to render scales (clear first to avoid duplicates)
    function renderScales(screenId, prefix="1") {
      ["valence","arousal","dominance"].forEach(scale => {
        const container = document.getElementById(scale + prefix);
        container.innerHTML = ""; // clear previous images
        for (let i=1; i<=SAM_OPTIONS; i++) {
          let img = document.createElement("img");
          img.src = "images/" + scale + "_" + i + ".png";
          img.dataset.value = i;
          img.dataset.scale = scale;
          img.onclick = () => selectOption(prefix, scale, img);
          container.appendChild(img);
        }
      });
    }

    function selectOption(prefix, scale, img) {
      const siblings = img.parentNode.querySelectorAll("img");
      siblings.forEach(sib => sib.classList.remove("selected"));
      img.classList.add("selected");

      if (prefix === "1") {
        responses.scale1[scale] = img.dataset.value;
        localStorage.setItem("responses", JSON.stringify(responses));

        if (
          responses.scale1.valence &&
          responses.scale1.arousal &&
          responses.scale1.dominance
        ) {
          firstScaleAnswered = true;
          responses.scale1.completedAt = new Date().toISOString();
          localStorage.setItem("responses", JSON.stringify(responses));

          if (secondScaleReady) {
            showScreen("sam-screen2");
            playNotify();
          } else {
            showScreen("idle-screen");
          }
        }
      }
      if (prefix === "2") {
        responses.scale2[scale] = img.dataset.value;
        localStorage.setItem("responses", JSON.stringify(responses));

        if (
          responses.scale2.valence &&
          responses.scale2.arousal &&
          responses.scale2.dominance
        ) {
          responses.scale2.completedAt = new Date().toISOString();
          localStorage.setItem("responses", JSON.stringify(responses));
          showScreen("end_screen");
        }
      }
    }

    function saveCSV() {
      let csv = "Scale, Timestamp, Valence, Arousal, Dominance\n";
      csv += `scale1, ${responses.scale1.completedAt||""}, ${responses.scale1.valence||""}, ${responses.scale1.arousal||""}, ${responses.scale1.dominance||""}\n`;
      csv += `scale2, ${responses.scale2.completedAt||""}, ${responses.scale2.valence||""}, ${responses.scale2.arousal||""}, ${responses.scale2.dominance||""}\n`;

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "results.csv";
      a.click();
      URL.revokeObjectURL(url);
      downloadResults = true;
    }

    function restartScenario() {
      if (!downloadResults) {
        alert("Please download the results before restarting.");
        return;
      }
      else {
        downloadResults = false; // reset for next round
      }
      localStorage.removeItem("responses");
      localStorage.removeItem("currentScreen");
      localStorage.removeItem("scenarioStart");
      responses = { scale1: {}, scale2: {} };
      secondScaleReady = false;
      firstScaleAnswered = false;
      renderScales("sam-screen1","1");
      renderScales("sam-screen2","2");
      showScreen("launch-screen");
    }

  </script>
</body>
</html>